# cloudjpå‘ã‘ã®CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ‰‹å‹•å®Ÿè¡Œã¨ãƒªãƒã‚¸ãƒˆãƒªãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã®ä¸¡æ–¹ã«å¯¾å¿œ
name: cloudjp CI/CD

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆGitHub UIçµŒç”±ï¼‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ' # ç’°å¢ƒé¸æŠã®èª¬æ˜
        required: true # å¿…é ˆå…¥åŠ›é …ç›®
        default: 'staging' # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’stagingã«è¨­å®š
        type: choice # é¸æŠå¼å…¥åŠ›
        options:
        - staging # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
        - production # æœ¬ç•ªç’°å¢ƒ
  
  # å¤–éƒ¨ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒï¼ˆcloudjpã‹ã‚‰è‡ªå‹•å®Ÿè¡Œï¼‰
  repository_dispatch:
    types: [cloudjp-test] # cloudjp-testã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’ç›£è¦–

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ¨©é™è¨­å®š
permissions:
  contents: read # ãƒªãƒã‚¸ãƒˆãƒªå†…å®¹ã®èª­ã¿å–ã‚Šæ¨©é™
  checks: write # ãƒã‚§ãƒƒã‚¯çµæœã®æ›¸ãè¾¼ã¿æ¨©é™
  pull-requests: read # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èª­ã¿å–ã‚Šæ¨©é™

# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  cloudjp-tests: # cloudjpãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
    runs-on: ubuntu-latest # Ubuntuæœ€æ–°ç‰ˆã§å®Ÿè¡Œ
    steps:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v4
      
      # Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰
      - uses: actions/setup-node@v4
        with:
          node-version: '18' # Node.js v18ã‚’ä½¿ç”¨
          cache: 'npm' # npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
      
      # CIç”¨ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆnpm ciã§é«˜é€Ÿã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
      - name: CIç”¨ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # CIç”¨ã®Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå…¨ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
      - name: CIç”¨ã®Playwrightã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npx playwright install --with-deps chromium firefox webkit # Chromeã€Firefoxã€Safariå¯¾å¿œ

      # ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨URLã‚’å‹•çš„ã«æ±ºå®š
      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ±ºå®š
        id: determine-env # ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        run: |
          # ãƒªãƒã‚¸ãƒˆãƒªãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã®å ´åˆã¯ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰ç’°å¢ƒæƒ…å ±ã‚’å–å¾—
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.client_payload.environment }}" # å¤–éƒ¨ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸç’°å¢ƒè¨­å®š
            BASE_URL="${{ github.event.client_payload.url }}" # å¤–éƒ¨ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸURL
          else
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å…¥åŠ›å€¤ã¨è¨­å®šæ¸ˆã¿ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨
            ENVIRONMENT="${{ github.event.inputs.environment }}" # æ‰‹å‹•å…¥åŠ›ã•ã‚ŒãŸç’°å¢ƒè¨­å®š
            if [[ "$ENVIRONMENT" == "production" ]]; then
              BASE_URL="${{ secrets.PROD_URL }}" # æœ¬ç•ªç’°å¢ƒURLï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å–å¾—ï¼‰
            else
              BASE_URL="${{ secrets.STAGING_URL }}" # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒURLï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å–å¾—ï¼‰
            fi
          fi
          
          # ç’°å¢ƒå¤‰æ•°ã‚’å‡ºåŠ›è¨­å®šã«ä¿å­˜ï¼ˆå¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
          echo "ğŸ¯ ãƒ†ã‚¹ãƒˆç’°å¢ƒ: $ENVIRONMENT"
          echo "ğŸŒ ãƒ†ã‚¹ãƒˆURL: $BASE_URL"
          echo "â° ãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"

      # cloudjpå‘ã‘Playwrightãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      - name: Playwrightãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        id: run-tests # ãƒ†ã‚¹ãƒˆçµæœã‚’ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        run: |
          echo "ãƒ†ã‚¹ãƒˆå¯¾è±¡ï¼š ${{ steps.determine-env.outputs.base_url }}" # ãƒ†ã‚¹ãƒˆå¯¾è±¡URLã‚’è¡¨ç¤º
          
          # cloudjpãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶šï¼‰
          npm run cloudjp || TEST_EXIT_CODE=$? # package.jsonã§å®šç¾©ã•ã‚ŒãŸcloudjpã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          
          # ãƒ†ã‚¹ãƒˆçµæœã‚’åˆ¤å®šã—ã¦å‡ºåŠ›è¨­å®šã«ä¿å­˜
          if [ -n "$TEST_EXIT_CODE" ]; then
            echo "test_result=failed" >> $GITHUB_OUTPUT # ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’è¨˜éŒ²
            echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•— (Exit code: $TEST_EXIT_CODE)" # å¤±æ•—ãƒ­ã‚°ã‚’å‡ºåŠ›
          else
            echo "test_result=passed" >> $GITHUB_OUTPUT # ãƒ†ã‚¹ãƒˆæˆåŠŸã‚’è¨˜éŒ²
            echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ" # æˆåŠŸãƒ­ã‚°ã‚’å‡ºåŠ›
          fi
        env:
          BASE_URL: ${{ steps.determine-env.outputs.base_url }} # ãƒ†ã‚¹ãƒˆå¯¾è±¡URLã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
      
      # ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã¨ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ steps.determine-env.outputs.environment }}-${{ github.run_id }} # ç’°å¢ƒã¨ãƒ©ãƒ³IDã‚’å«ã‚€ä¸€æ„ãªåå‰
          path: | # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®ãƒ‘ã‚¹
            playwright-report/
            test-results/
          retention-days: 14 # ä¿å­˜æœŸé–“ï¼ˆ14æ—¥é–“ï¼‰

      # cloudjpãƒªãƒã‚¸ãƒˆãƒªã«ãƒ†ã‚¹ãƒˆå®Œäº†ã‚’é€šçŸ¥
      - name: cloudjpã«ãƒ†ã‚¹ãƒˆçµæœã‚’é€ä¿¡
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.CLOUD_JP_REPO_TOKEN }} # cloudjpãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
          repository: richclaudfelixjp/cloudjp-frontend # é€šçŸ¥å…ˆãƒªãƒã‚¸ãƒˆãƒª
          event-type: e2e-test-complete # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆcloudjpã§ç›£è¦–ï¼‰
          client-payload: | # é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
            {
              "commit_sha": "${{ github.event.client_payload.commit_sha || github.sha }}",
              "environment": "${{ steps.determine-env.outputs.environment }}",
              "test_result": "${{ steps.run-tests.outputs.test_result }}",
              "test_url": "${{ steps.determine-env.outputs.base_url }}",
              "run_id": "${{ github.run_id }}",
              "run_timestamp": "$(date -u '+%Y-%m-%d %H:%M:%S')",
              "triggered_by": "${{ github.event.client_payload.triggered_by || github.actor }}"
            }